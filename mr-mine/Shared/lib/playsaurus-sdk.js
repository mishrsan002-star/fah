(function(d,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(d=typeof globalThis<"u"?globalThis:d||self,d.Playsaurus=h())})(this,function(){"use strict";class d{_listeners=[];add(e){this._listeners.push(e)}remove(e){const t=this._listeners.indexOf(e);t>=0&&this._listeners.splice(t,1)}emit(e){for(const t of this._listeners)t(e)}}var h=(i=>(i.Offline="offline",i.Online="online",i.Wifi="wifi",i.Ethernet="ethernet",i.Mobile="mobile",i))(h||{}),T=(i=>(i.Windows="windows",i.Linux="linux",i.MacOS="macos",i.Android="android",i.IOS="ios",i))(T||{});class ie{static getConnectionType(){const e=window.navigator,t=e.connection||e.mozConnection||e.webkitConnection;if(!t)return h.Online;const n={bluetooth:h.Mobile,cellular:h.Mobile,ethernet:h.Ethernet,none:h.Offline,wifi:h.Wifi,wimax:h.Mobile,unknown:null}[t.type||"unknown"];return n||(t.saveData===!0?h.Mobile:h.Online)}}class ne{async detectGpuName(){const e=this.tryWebGlLegacy();if(e)return e;const t=await this.tryWebGpu();if(t)return t;const n=this.tryWebGlModern();return n||null}async tryWebGpu(){try{if(!navigator.gpu)return null;const e=await Promise.race([navigator.gpu.requestAdapter(),new Promise(r=>setTimeout(()=>r(null),1e3))]);if(!e)return null;const t=e.info;if(t.description&&t.description.trim()!=="")return t.description;const n=[];return t.vendor&&t.vendor.trim()!==""&&n.push(t.vendor),t.architecture&&t.architecture.trim()!==""&&n.push(t.architecture),n.length>0?n.join(" "):null}catch{return null}}tryWebGlModern(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t||!("getParameter"in t))return null;const n=t.getParameter(t.RENDERER);return n&&typeof n=="string"&&n.trim()!==""?n:null}catch{return null}}tryWebGlLegacy(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t||!("getExtension"in t))return null;const n=t.getExtension("WEBGL_debug_renderer_info");if(!n)return null;const r=t.getParameter(n.UNMASKED_RENDERER_WEBGL);return r&&typeof r=="string"&&r.trim()!==""?r:null}catch{return null}}}class A{_initialized=!1;async collect(e,t){return this._initialized||(await this.initialize(),this._initialized=!0),this.fillContextInfo(e,t),e.connectionType=this.getConnectionType(),e.osName=this.getOsName(),e.osVersion=this.getOsVersion(),e.deviceModel=this.getDeviceModel(),e.deviceType=this.getDeviceType(),e.deviceManufacturer=this.getDeviceManufacturer(),e.deviceLocale=this.getDeviceLocale(),e.deviceTimezone=this.getDeviceTimezone(),e.deviceRamMb=this.getDeviceRamMb(),e.deviceCpuCores=this.getDeviceCpuCores(),e.deviceCpuMhz=this.getDeviceCpuMhz(),e.deviceVramMb=this.getDeviceVramMb(),e.deviceGpuName=await this.getDeviceGpuName(),e.gameGraphicsApi=this.getGameGraphicsApi(),e.screenWidth=this.getScreenWidth(),e.screenHeight=this.getScreenHeight(),e.screenDpi=this.getScreenDpi(),e.screenCount=this.getScreenCount(),Promise.resolve()}async initialize(){return Promise.resolve()}fillContextInfo(e,t){e.gameLocale=t.gameLocale,e.steamId=t.steamId,e.deviceIdfa=t.deviceIdfa,e.deviceGaid=t.deviceGaid}getOsName(){return null}getOsVersion(){return null}getDeviceModel(){return null}getDeviceManufacturer(){return null}getDeviceType(){return null}getDeviceLocale(){return navigator.language}getDeviceTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}getDeviceCpuMhz(){return null}getGameGraphicsApi(){return null}getDeviceRamMb(){return typeof navigator.deviceMemory<"u"?navigator.deviceMemory*1024:null}getScreenWidth(){return window.devicePixelRatio?Math.floor(window.screen.width*window.devicePixelRatio):window.screen.width}getScreenHeight(){return window.devicePixelRatio?Math.floor(window.screen.height*window.devicePixelRatio):window.screen.height}getScreenDpi(){return window.devicePixelRatio?Math.round(window.devicePixelRatio*96):null}getConnectionType(){return ie.getConnectionType()}getDeviceCpuCores(){return typeof navigator.hardwareConcurrency<"u"?navigator.hardwareConcurrency:null}getDeviceVramMb(){return null}async getDeviceGpuName(){return new ne().detectGpuName()}getScreenCount(){return window.screen&&typeof window.screen.isExtended<"u"?window.screen.isExtended?2:1:null}}class se{event;constructor(e){this.event=e}get session(){return this.event.session}get queueLength(){return this.session.pendingEvents.length}}class re{batches;retryAfter;constructor(e,t){this.batches=e,this.retryAfter=t}}class I{static start(){return new I}_start;constructor(){this._start=Date.now()}get elapsed(){return Date.now()-this._start}}class ae{events;response=null;duration=-1;innerError=null;constructor(e,t,n){this.events=e,this.response=t instanceof y?t.response:null,this.innerError=t??null,this.duration=n??-1}get session(){return this.events[0].session}}class oe{events;constructor(e){this.events=e}get session(){return this.events[0].session}}class le{events;response=null;duration=0;constructor(e,t,n){this.events=e,this.response=t??null,this.duration=n??-1}get session(){return this.events[0].session}}class y extends Error{response;shouldRetry;duration;constructor(e,t,n){super(e??`Request failed with status code ${t?.status??0}`),this.response=t??null,this.shouldRetry=this._shouldRetry(t),this.duration=n??0}static fromResponse(e,t){return new y(void 0,e,t)}_shouldRetry(e){if(!e)return!1;const t=Math.floor((e?.status??0)/100);return t===5||t===0||e.status===429}}class ce{onEventsSending=()=>{};onEventsSent=()=>{};onEventsFailed=()=>{};endpoint;maxEventsPerRequest=20;constructor(e,t){this.endpoint=e,this.maxEventsPerRequest=t??20}async flush(e){if(e.length===0)return[];const t=this._createBatches(e);let n=!1;for(let r=0;r<t.length;r++){const a=t[r];if(n){a.markAsFailAndRetry();continue}if(await this._sendBatch(a),a.shouldRetry){n=!0;break}}if(n)for(const r of t.filter(a=>a.shouldRetry))r.session.returnFailedEventsToQueue(r.events);return t}async sendHeartbeat(e){await this._send(e,[])}_createBatches(e){return e.flatMap(t=>t.createBatches(this.maxEventsPerRequest))}async _send(e,t){const n={ts:new Date().toISOString(),events:t.map(g=>g.toJSON()),session:e.toJSON()},r=I.start(),a=await fetch(`${this.endpoint}/v2/events`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify(n),keepalive:!0}),u=r.elapsed;if(!a.ok)throw y.fromResponse(a,u);return{response:a,duration:u}}async _sendBatch(e){const{session:t,events:n}=e;if(!t.isDataCollected){e.markAsFailAndRetry();return}if(navigator.onLine===!1){e.markAsFailAndRetry();return}this.onEventsSending(new oe(n));try{const{response:r,duration:a}=await this._send(t,n);this.onEventsSent(new le(n,r,a)),e.markAsSent()}catch(r){const a=r instanceof y?r.shouldRetry:!0,u=r instanceof y?r.duration:0;a?e.markAsFailAndRetry():e.markAsFailAndSkip(),this.onEventsFailed(new ae(n,r,u))}}}class de{_timeoutId=null;_failedAttempts=0;_nextFlushAt=null;get failedAttempts(){return this._failedAttempts}get nextFlushAt(){return this._nextFlushAt}onFlush;debounceTime=15;_currentBackoffTime=-1;get retryTime(){return this._currentBackoffTime}constructor(e,t){this.onFlush=e,this.debounceTime=t||this.debounceTime}_scheduleNextFlushIn(e){this._timeoutId&&window.clearTimeout(this._timeoutId),e*=1e3,this._nextFlushAt=new Date(Date.now()+e),this._timeoutId=window.setTimeout(this.onFlush,e)}clear(){this._timeoutId&&(window.clearTimeout(this._timeoutId),this._timeoutId=null)}_getExponentialBackoff(e){return Math.min(2**(e-1)*this.debounceTime,3600)}scheduleRetry(){this._currentBackoffTime=this._getExponentialBackoff(++this._failedAttempts),this._scheduleNextFlushIn(this._currentBackoffTime)}scheduleNextFlush(){this._failedAttempts=0,this._currentBackoffTime=-1,this._scheduleNextFlushIn(this.debounceTime)}}const o=[];for(let i=0;i<256;++i)o.push((i+256).toString(16).slice(1));function $(i,e=0){return(o[i[e+0]]+o[i[e+1]]+o[i[e+2]]+o[i[e+3]]+"-"+o[i[e+4]]+o[i[e+5]]+"-"+o[i[e+6]]+o[i[e+7]]+"-"+o[i[e+8]]+o[i[e+9]]+"-"+o[i[e+10]]+o[i[e+11]]+o[i[e+12]]+o[i[e+13]]+o[i[e+14]]+o[i[e+15]]).toLowerCase()}let R;const ue=new Uint8Array(16);function F(){if(!R){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");R=crypto.getRandomValues.bind(crypto)}return R(ue)}const U={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function he(i,e,t){i=i||{};const n=i.random??i.rng?.()??F();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,$(n)}function me(i,e,t){return U.randomUUID&&!i?U.randomUUID():he(i)}const O={};function q(i,e,t){let n;{const r=Date.now(),a=F();ge(O,r,a),n=_e(a,O.msecs,O.seq,e,t)}return e??$(n)}function ge(i,e,t){return i.msecs??=-1/0,i.seq??=0,e>i.msecs?(i.seq=t[6]<<23|t[7]<<16|t[8]<<8|t[9],i.msecs=e):(i.seq=i.seq+1|0,i.seq===0&&i.msecs++),i}function _e(i,e,t,n,r=0){if(i.length<16)throw new Error("Random bytes length must be >= 16");if(!n)n=new Uint8Array(16),r=0;else if(r<0||r+16>n.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);return e??=Date.now(),t??=i[6]*127<<24|i[7]<<16|i[8]<<8|i[9],n[r++]=e/1099511627776&255,n[r++]=e/4294967296&255,n[r++]=e/16777216&255,n[r++]=e/65536&255,n[r++]=e/256&255,n[r++]=e&255,n[r++]=112|t>>>28&15,n[r++]=t>>>20&255,n[r++]=128|t>>>14&63,n[r++]=t>>>6&255,n[r++]=t<<2&255|i[10]&3,n[r++]=i[11],n[r++]=i[12],n[r++]=i[13],n[r++]=i[14],n[r++]=i[15],n}class k{id;session;name;timestamp;properties;constructor(e,t,n,r,a){this.id=a??q(),this.session=e,this.name=t,this.timestamp=n,this.properties=r??{}}sendCount=0;toJSON(){return{id:this.id,name:this.name,t:this.timestamp.toISOString(),properties:Object.keys(this.properties).length>0?this.properties:void 0}}toStorage(){return this.toJSON()}static fromStorage(e,t){const n=t.name,r=new Date(t.t),a=t.properties,u=t.id;return new k(e,n,r,a,u)}}class pe{constructor(e){if(this.events=e,e.length===0)throw new Error("The events list cannot be empty.");this.events=e,this.session=e[0].session;for(const t of e)if(t.session!==this.session)throw new Error("All events must belong to the same session.")}session;status="pending";shouldRetry=!1;markAsFailAndRetry(){this.status="failed",this.shouldRetry=!0}markAsFailAndSkip(){this.status="failed",this.shouldRetry=!1}markAsSent(){this.status="sent",this.shouldRetry=!1}}class S{id;pendingEvents=[];isDataCollected=!1;constructor(e){this.id=e??q()}pushEvent(e,t){const n=new k(this,e,new Date,t);return this.pendingEvents.push(n),n}dequeueEvents(e){return this.pendingEvents.splice(0,e)}returnFailedEventsToQueue(e){this.pendingEvents.push(...e)}createBatches(e){const t=[];let n=this.dequeueEvents(e);for(;n.length>0;)t.push(new pe(n)),n=this.dequeueEvents(e);return t}userId=null;osName=null;osVersion=null;deviceModel=null;deviceType=null;deviceManufacturer=null;deviceLocale=null;gameLocale=null;deviceTimezone=null;deviceRamMb=null;deviceCpuCores=null;deviceCpuMhz=null;deviceVramMb=null;deviceGpuName=null;gameGraphicsApi=null;screenWidth=null;screenHeight=null;screenDpi=null;screenCount=null;connectionType=null;deviceGaid=null;deviceIdfa=null;steamId=null;toJSON(){return S._removeNulls({id:this.id,user_id:this.userId,os_name:this.osName,os_version:this.osVersion,device_model:this.deviceModel,device_type:this.deviceType,device_manufacturer:this.deviceManufacturer,device_locale:this.deviceLocale,game_locale:this.gameLocale,device_timezone:this.deviceTimezone,device_ram_mb:this.deviceRamMb,device_cpu_cores:this.deviceCpuCores,device_cpu_mhz:this.deviceCpuMhz,device_vram_mb:this.deviceVramMb,device_gpu_name:this.deviceGpuName,game_graphics_api:this.gameGraphicsApi,screen_width:this.screenWidth,screen_height:this.screenHeight,screen_dpi:this.screenDpi,screen_count:this.screenCount,connection_type:this.connectionType,device_gaid:this.deviceGaid,device_idfa:this.deviceIdfa,steam_id:this.steamId})}static _removeNulls(e){return Object.keys(e).forEach(t=>{(e[t]===null||e[t]===void 0)&&delete e[t]}),e}toStorage(){return{id:this.id,is_data_collected:this.isDataCollected,...this.toJSON(),pending_events:this.pendingEvents.map(e=>e.toStorage())}}static fromStorage(e){const t=Object.assign(new S(e.id),S._removeNulls({isDataCollected:e.is_data_collected??!0,userId:e.user_id,osName:e.os_name,osVersion:e.os_version,deviceModel:e.device_model,deviceType:e.device_type,deviceManufacturer:e.device_manufacturer,deviceLocale:e.device_locale,deviceTimezone:e.device_timezone,gameLocale:e.game_locale,deviceRamMb:e.device_ram_mb,deviceCpuCores:e.device_cpu_cores,deviceCpuMhz:e.device_cpu_mhz,deviceVramMb:e.device_vram_mb,deviceGpuName:e.device_gpu_name,gameGraphicsApi:e.game_graphics_api,screenWidth:e.screen_width,screenHeight:e.screen_height,screenDpi:e.screen_dpi,screenCount:e.screen_count,connectionType:e.connection_type,deviceGaid:e.device_gaid,deviceIdfa:e.device_idfa,steamId:e.steam_id}));return e.pending_events&&(t.pendingEvents=e.pending_events.map(n=>k.fromStorage(t,n))),t}}class fe{_pendingSessions=new Set;_storage;constructor(e){this._storage=e}add(e){this._pendingSessions.add(e)}addRange(e){for(const t of e)this.add(t)}remove(e){this._pendingSessions.delete(e)}async save(){const e={v:2,sessions:[...this._pendingSessions].map(t=>t.toStorage())};await this._storage.set("playsaurus-analytics-sessions",JSON.stringify(e))}async restore(){const e=await this._storage.get("playsaurus-analytics-sessions");if(!e)return[];const t=JSON.parse(e);if(t.v!==2)return[];const n=t.sessions.map(r=>S.fromStorage(r));for(const r of n)this.add(r);return n}getAll(){return[...this._pendingSessions]}dequeueAll(){const e=this.getAll();return this._pendingSessions.clear(),e}}class we{async get(e){return localStorage.getItem(e)}async set(e,t){localStorage.setItem(e,t)}async remove(e){localStorage.removeItem(e)}}class ve{sdkVersion=s.version;endpoint="";maxEventsPerRequest=20;flushDebounceTime=15;heartbeatInterval=600;steamId;_batchSending=new d;_batchSent=new d;_batchFailed=new d;_eventQueued=new d;_retryScheduled=new d;get batchSending(){return this._batchSending}get batchSent(){return this._batchSent}get batchFailed(){return this._batchFailed}get eventQueued(){return this._eventQueued}get retryScheduled(){return this._retryScheduled}_session=null;_pendingSessions;_isSending=!1;_scheduler;_dataCollector;_storage;_collectionContext;_flushingService;_heartbeatTimeoutId=null;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required.");if(!e.endpoint)throw new Error("The endpoint is required.");this.endpoint=`${e.endpoint}/games/${e.gameSlug}`;const t=e.analytics??{};this.maxEventsPerRequest=t.maxEventsPerRequest??20,this.flushDebounceTime=t.flushDebounceTime??15,this.heartbeatInterval=t.heartbeatInterval??600,this._collectionContext={gameLocale:s.locale,deviceGaid:t.deviceGaid??null,deviceIdfa:t.deviceIdfa??null,steamId:typeof t.steamId=="bigint"?t.steamId.toString():t.steamId??null},this._dataCollector=t.dataCollector??new A,this._storage=t.storageDriver??new we,this._pendingSessions=new fe(this._storage),this._flushingService=new ce(this.endpoint,this.maxEventsPerRequest),this._flushingService.onEventsSending=n=>this._batchSending.emit(n),this._flushingService.onEventsSent=n=>this._batchSent.emit(n),this._flushingService.onEventsFailed=n=>this._batchFailed.emit(n),this._scheduler=new de(()=>this.flush(),this.flushDebounceTime),this._session=this._newSession(),this._pendingSessions.restore(),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.flush()}),this._scheduler.scheduleNextFlush(),this._scheduleHeartbeat(),s.localeChanged.add(()=>this._handlePlaysaurusLocaleChanged())}_scheduleHeartbeat(){this._heartbeatTimeoutId&&window.clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=window.setTimeout(()=>this._sendHeartbeat(),this.heartbeatInterval*1e3)}async _sendHeartbeat(){try{this._session?.isDataCollected&&await this._flushingService.sendHeartbeat(this._session)}finally{this._scheduleHeartbeat()}}_handlePlaysaurusLocaleChanged(){this._collectionContext.gameLocale=s.locale,this.sendEvent("locale_changed",{locale:s.locale})}_newSession(){const e=new S;return this._session=e,this.sendEvent("session_started"),this._collectData(e),e}async endSession(){if(this._scheduler.clear(),this._heartbeatTimeoutId&&(window.clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=null),!this._session)return Promise.resolve();this.sendEvent("session_ended"),await this.flush(),this._session=null}_getActiveSession(){return this._session??=this._newSession(),this._session}sendEvent(e,t){const n=this._getActiveSession(),r=n.pushEvent(e,t);this._pendingSessions.add(n),this._eventQueued.emit(new se(r)),n.pendingEvents.length>=this.maxEventsPerRequest?this._scheduler.failedAttempts===0&&this.flush():this._scheduler.scheduleNextFlush()}async _collectData(e){e.isDataCollected||(await this._dataCollector.collect(e,this._collectionContext),e.isDataCollected=!0,await this._pendingSessions.save())}async flush(){if(!this._isSending){this._isSending=!0;try{await this._pendingSessions.save();const e=this._pendingSessions.dequeueAll();if(e.length===0){this._isSending=!1;return}const n=(await this._flushingService.flush(e)).filter(r=>r.shouldRetry);n.length>0?(this._pendingSessions.addRange(n.map(r=>r.session)),this._scheduler.scheduleRetry(),this._retryScheduled.emit(new re(n,this._scheduler.retryTime))):(this._scheduler.scheduleNextFlush(),this._scheduleHeartbeat()),await this._pendingSessions.save()}finally{this._isSending=!1}}}}class M{id="";locale="en";title="";body="";button="";link="";image={url:"",alt:""};static fromRequest(e){const t=new M;return t.id=e.id,t.locale=e.locale,t.title=e.title,t.body=e.body,t.button=e.button,t.link=e.link,t.image=e.image,t}_sw=null;_clicked=!1;_finalReadTime=null;start(){if(this._sw!==null)throw new Error("Announcement has already been started.");this._sw=I.start()}markAsClicked(){this.markAsDismissed(!0)}markAsDismissed(e=!1){if(this._sw===null)throw new Error("Announcement has not been started.");this._clicked=e,this._finalReadTime=this._sw.elapsed,this._sw=null}get isRunning(){return this._sw!==null}get clicked(){return this._clicked}get readTime(){return this._finalReadTime!==null?this._finalReadTime:this._sw===null?0:this._sw.elapsed}}class ye{_parent;_announcement=null;_dialog=null;onClicked=()=>{};onDismissed=()=>{};_options;constructor(e,t){this._announcement=e,this._parent=document.body,this._options=t||{},this.render()}get announcement(){return this._announcement}set announcement(e){this._announcement!==e&&(this._announcement=e,this.render())}_closeIconSvg=`
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
    `;render(){if(this._dialog===null&&(this._dialog=document.createElement("dialog"),this._dialog.classList.add("playsaurus-announcement-dialog"),this._dialog.classList.add(this._options.theme||"light"),this._parent.appendChild(this._dialog)),this._announcement===null){this._dialog.innerHTML="";return}const e=this._announcement.title,t=this._announcement.body,n=this._announcement.button||"Learn More",r=this._announcement.image?.url,a=this._announcement.image?.alt||e,u=this._announcement.link,g=[];if(r&&g.push(`<img class="image" src="${r}" alt="${a}"/>`),t&&g.push(`<p class="body">${t}</p>`),u){const v=u.startsWith("http")?u:"javascript:void(0)";g.push(`<a href="${v}" target="_blank" class="button">
                ${n}
            </a>`)}const p=`<button class="close-button">${this._closeIconSvg}</button>`,Re=`<div class="header">
            <h1 class="title">${e}</h1>
            ${p}
        </div>`;this._dialog.innerHTML=`
            ${Re}
            ${g.join(`
`)}
        `;const Z=this._dialog.querySelector("a.button"),ee=this._dialog.querySelector("button.close-button");Z&&Z.addEventListener("click",v=>{u&&!u.startsWith("http")&&v.preventDefault(),this._dialog?.close(),this.onClicked()}),ee&&ee.addEventListener("click",v=>{v.preventDefault(),this._dialog?.close(),this.onDismissed()}),this._options.dismissable&&this._dialog.addEventListener("click",v=>{v.target===this._dialog&&(this._dialog?.close(),this.onDismissed())})}show(){this._dialog?.showModal()}}class Se{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/announcements`}async fetch(){const e=await fetch(`${this._endpoint}/latest`,{headers:s.getDefaultHeaders()});if(!e.ok)throw new Error(`Failed to fetch latest announcement: ${e.status} ${e.statusText}`);if(e.status===204)return null;const t=await e.json();return M.fromRequest(t)}async fetchAndShowDialog(e){const t=await this.fetch();return this.showDialog(t,e)}async showDialog(e,t){return e?new Promise(n=>{const r=new ye(e,t);r.onClicked=()=>{e.markAsClicked(),this.sendInteraction(e),n(e)},r.onDismissed=()=>{e.markAsDismissed(),this.sendInteraction(e),n(e)},e.start(),r.show()}):null}async sendInteraction(e){e.isRunning&&e.markAsDismissed();const t=await fetch(`${this._endpoint}/interactions`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({announcement_id:e.id,read_time:e.readTime,clicked:e.clicked,locale:e.locale})});if(!t.ok)throw new Error(`Failed to send interaction: ${t.status} ${t.statusText}`)}}class f{static generateDeviceName(){const e=navigator.userAgentData;if(e?.brands&&e.brands.length>0){const a=e.brands.map(p=>[f._simplifyBrandName(p.brand),p.brand]).filter(p=>!f._isInvalidBrand(p[0])).map(p=>p[1]),u=a[a.length-1],g=e.platform||"";return g?`${u} on ${g}`.trim():u.trim()}const t=window.navigator.userAgent,n=f._getBrowserFromUA(t),r=f._getPlatformFromNavigatorPlatform(window.navigator.platform||"");return r?`${n} on ${r}`.trim():n.trim()}static _simplifyBrandName(e){return e.toLowerCase().replace(/[^a-z]/g,"")}static _isInvalidBrand(e){return e.includes("notabrand")||e.includes("notbrand")||e.includes("chromium")}static _getBrowserFromUA(e){return e.indexOf("Edg")>-1?"Microsoft Edge":e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Safari")>-1?"Safari":e.indexOf("Opera")>-1?"Opera":e.indexOf("Trident")>-1||e.indexOf("MSIE")>-1?"Internet Explorer":"Unknown Browser"}static _getPlatformFromNavigatorPlatform(e){return e?e.indexOf("Mac")===0?"Mac":e.indexOf("Win")>0?"Windows":e.indexOf("Linux")===0?"Linux":e:""}}class m extends Error{response;data;constructor(e,t,n=null){super(`${e} (${t.status} ${t.statusText})`),this.response=t,this.data=n}get serverMessage(){return this.data instanceof Object&&"message"in this.data?this.data.message:null}get status(){return this.response.status}}class H extends m{errors;constructor(e,t){super(`Validation error: ${e.status} ${e.statusText}`,e,t),this.errors=t instanceof Object&&"errors"in t?t.errors:{}}}class J extends m{constructor(e,t=null){super("Unauthorized",e,t)}}class B extends m{constructor(e,t=null){super("Forbidden",e,t)}get reason(){return this.data instanceof Object&&"reason"in this.data?this.data.reason:null}}class G extends m{constructor(e,t=null){super("Too many requests",e,t)}}class P extends m{constructor(e,t=null){super("The server is under maintenance",e,t)}get serverMessage(){return super.serverMessage==="Service Unavailable"||!super.serverMessage?null:super.serverMessage}}class l{static async assertOk(e){const t=async()=>e.headers.get("content-type")?.includes("application/json")?await e.json():await e.text();if(e.status===422)throw new H(e,await t());if(e.status===429)throw new G(e,await t());if(e.status===401)throw s.authToken=null,new J(e,await t());if(e.status===403)throw new B(e,await t());if(e.status===503)throw new P(e,await t());if(!e.ok)throw new m("Failed to fetch data",e,await t())}}class be{error;get message(){return this.error?.message}constructor(e){this.error=e}}class V{method;constructor(e){this.method=e}get success(){return this.method!==z.None}}var W=(i=>(i.Default="default",i.Login="login",i.Register="register",i))(W||{}),z=(i=>(i.None="none",i.ClassicLogin="classic_login",i.ClassicRegister="classic_register",i.ConfirmLogin="confirm_login",i))(z||{});class Te{_iframe;_container;_options;_origin;_url;_returned=new d;_loaded=new d;_closed=new d;_failed=new d;_iframeTimeout=null;constructor(e){this._options=e,this._options.showClose??=!1,this._container=e.container instanceof HTMLElement?e.container:document.querySelector(e.container);const t=e.deviceName||f.generateDeviceName();this._url=this._getFinalUrl(e.url,t).toString(),this._origin=new URL(this._url).origin,this._handleMessage=this._handleMessage.bind(this),this._handleReady=this._handleReady.bind(this)}open(){return this._iframe?this:(this._iframe=document.createElement("iframe"),this._iframe.style.width="100%",this._iframe.style.height="100%",this._iframe.style.border="none",this._iframe.referrerPolicy="no-referrer-when-downgrade",this._iframe.style.visibility="hidden",this._options.iFrameClass&&this._iframe.classList.add(this._options.iFrameClass),this._container.appendChild(this._iframe),window.addEventListener("message",this._handleMessage),this._iframe.addEventListener("error",e=>this._handleError(e.error)),this._isLoading=!0,this._iframe.src=this._url,this._iframeTimeout=setTimeout(()=>{this._handleError(new Error("The auth frame took too long to load."))},(this._options.timoutSeconds||10)*1e3),this)}_isLoading=!1;get isLoading(){return this._isLoading}get iFrame(){return this._iframe}get returned(){return this._returned}get loaded(){return this._loaded}get closed(){return this._closed}get failed(){return this._failed}_clearIframeTimeout(){this._iframeTimeout&&(clearTimeout(this._iframeTimeout),this._iframeTimeout=null)}close(){this._iframe&&(this._clearIframeTimeout(),this._isLoading=!1,window.removeEventListener("message",this._handleMessage),this._container.removeChild(this._iframe),this._iframe=void 0,this._closed.emit())}_handleMessage(e){if(e.origin!==this._origin){console.warn(`Expected message from ${this._origin}, but received message from ${e.origin}`),console.warn(e);return}const t=e.data;switch(t.type){case"READY":this._handleReady(t);break;case"SUCCESS":this._handleSuccess(t);break;case"CLOSE":this._handleClose(t);break;default:console.warn("Received unknown message from auth frame:"),console.warn(t)}}_handleReady(e){this._iframe&&this._isLoading&&(this._clearIframeTimeout(),this._isLoading=!1,this._iframe.style.visibility="visible",this._loaded.emit())}_handleError(e){this._iframe&&this._isLoading&&(this._clearIframeTimeout(),console.error("An error occurred while loading the auth frame:"),console.error(e),this._failed.emit(new be(e)))}_handleSuccess(e){const{token:t,method:n}=e;s.authToken=t,this.close(),this._returned.emit(new V(n))}_handleClose(e){this.close(),this._returned.emit(new V("none"))}_getDefaultUrl(){return new URL("/embed/auth",new URL(s.config.endpoint).origin)}_getFinalUrl(e,t){const n=e?new URL(e):this._getDefaultUrl();return n.search=new URLSearchParams({game:s.config.gameSlug,parent_uri:window.location.origin,device_name:t,user_atomic_id:s.getAtomicId(),user_uid:s.config.userUid||"",platform:s.config.gamePlatform||"",action:this._options.action||"default",show_close:this._options.showClose?"1":"0"}).toString(),n}}class N{id=0;displayName="";name=null;username="";email="";gender=null;dateOfBirth=null;emailVerifiedAt=null;createdAt=null;updatedAt=null;editProfileLink=null;avatarUrl="";static fromResponse(e){const t=new N;return t.id=e.id,t.displayName=e.display_name,t.name=e.name??null,t.username=e.username,t.gender=e.gender??null,t.dateOfBirth=e.date_of_birth?new Date(e.date_of_birth):null,t.email=e.email,t.emailVerifiedAt=e.email_verified_at?new Date(e.email_verified_at):null,t.createdAt=new Date(e.created_at),t.updatedAt=new Date(e.updated_at),t.editProfileLink=e.edit_profile_link??null,t.avatarUrl=e.avatar_url,t}}class Ee{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}`}async register(e){const t=await fetch(`${this._endpoint}/register`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({name:e.name||null,username:e.username,email:e.email,password:e.password,password_confirmation:e.passwordConfirmation,device_name:e.deviceName||this.generateDeviceName(),terms_of_service:!!e.termsOfService})});await l.assertOk(t);const n=await t.json();s.authToken=n.token}async login(e){const t=await fetch(`${this._endpoint}/login`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({email:e.email,password:e.password,device_name:e.deviceName||this.generateDeviceName()})});await l.assertOk(t);const n=await t.json();s.authToken=n.token}async logout(){const e=await fetch(`${this._endpoint}/logout`,{method:"POST",headers:s.getDefaultHeaders()});await l.assertOk(e),s.authToken=null}async resetPassword(e){const t=await fetch(`${this._endpoint}/password/email`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({email:e.email})});return await l.assertOk(t),await t.json()}async getProfile(){const e=await fetch(`${this._endpoint}/profile`,{method:"GET",headers:s.getDefaultHeaders()});await l.assertOk(e);const t=await e.json();return N.fromResponse(t.data)}async resendEmailVerification(){const e=await fetch(`${this._endpoint}/email/verification-notification`,{method:"POST",headers:s.getDefaultHeaders()});await l.assertOk(e);const t=await e.json();return{message:t.message,emailVerifiedAt:t.email_verified_at?new Date(t.email_verified_at):null}}get isLoggedIn(){return!!s.authToken}get authToken(){return s.authToken}generateDeviceName(){return f.generateDeviceName()}createAuthFrame(e){return new Te(e)}}class w{id=0;playTime=0;platform=null;gameVersion="";filename="";fileSize=0;metadata={};createdAt=null;updatedAt=null;startedPlayingAt=null;static fromResponse(e){const t=new w;return t.id=e.id,t.playTime=e.play_time,t.platform=e.platform,t.gameVersion=e.game_version,t.filename=e.filename,t.fileSize=e.file_size,t.metadata=e.metadata,t.createdAt=new Date(e.created_at),t.updatedAt=new Date(e.updated_at),t.startedPlayingAt=e.started_playing_at?new Date(e.started_playing_at):null,t}}class De{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/cloud-saves`}_getFormData(e,t=null){const n=new FormData;n.append("file",e.file,e.fileName||"save.dat");const r={play_time:Math.floor(e.playTime).toString(),started_playing_at:e.startedPlayingAt?.toISOString()??void 0,metadata:JSON.stringify(e.metadata)};for(const a in r)n.append(a,r[a]??"");return t&&n.append("_method",t),n}async create(e){const t=await fetch(this._endpoint,{method:"POST",headers:s.getDefaultHeaders(!1),body:this._getFormData(e)});await l.assertOk(t);const n=await t.json();return w.fromResponse(n.data)}async update(e,t){const n=await fetch(`${this._endpoint}/${e}`,{method:"POST",headers:s.getDefaultHeaders(!1),body:this._getFormData(t,"PUT")});await l.assertOk(n);const r=await n.json();return w.fromResponse(r.data)}async updateOrCreate(e,t){if(!e||e<=0)return await this.create(t);try{return await this.update(e,t)}catch(n){if(n instanceof m&&(n.status===404||n.status===403))return await this.create(t);throw n}}async getAll(){const e=await fetch(this._endpoint,{method:"GET",headers:s.getDefaultHeaders()});return await l.assertOk(e),(await e.json()).data.map(n=>w.fromResponse(n))}async get(e){const t=await fetch(`${this._endpoint}/${e}`,{method:"GET",headers:s.getDefaultHeaders()});await l.assertOk(t);const n=await t.json();return w.fromResponse(n.data)}async delete(e){const t=await fetch(`${this._endpoint}/${e}`,{method:"DELETE",headers:s.getDefaultHeaders()});await l.assertOk(t)}async download(e){const t=await fetch(`${this._endpoint}/${e}/file`,{method:"GET",headers:s.getDefaultHeaders()});return await l.assertOk(t),t.blob()}}var L=(i=>(i.Other="other",i.Web="web",i.Desktop="desktop",i.Ios="ios",i.Android="android",i))(L||{}),_=(i=>(i.Int="int",i.Double="double",i.String="string",i.Json="json",i.None="none",i))(_||{});class x{code="";message=null;rewardType="";value=null;valueDataType=_.None;static fromJson(e){const t=new x;return t.code=e.code,t.message=e.message,t.rewardType=e.reward_type,t.valueDataType=e.reward_data_type,t.value=x._parseValue(e.reward_value,t.valueDataType),t}static _parseValue(e,t){switch(t){case _.Int:return parseInt(e,10);case _.Double:return parseFloat(e);case _.String:return e;case _.Json:return JSON.parse(e);case _.None:return null;default:return null}}}class j extends m{constructor(e,t=null){const n=t instanceof Object&&"message"in t?t.message:"Failed to redeem coupon";super(n,e,t)}}class Ie{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/coupons`}async redeem(e){const t=await fetch(`${this._endpoint}/redeem`,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({code:e})}),n=await t.json();if(t.status===400)throw new j(t,n);return await l.assertOk(t),x.fromJson(n)}}class c{static _zeros=new Map;amount="0.00";currency="USD";_formatted=void 0;static fromJson(e){if(!e.amount||!e.currency)throw new Error("Invalid Money JSON");return new c(e.amount,e.currency,e.formatted??null)}constructor(e,t,n){if(typeof e!="string"||e.length===0)throw new Error("The amount must be a non-empty string");this.amount=e,this.currency=t,this._formatted=n}static zero(e){let t=c._zeros.get(e);return t||(t=new c("0.00",e),c._zeros.set(e,t)),t}get minorUnits(){return parseInt(this.amount.replace(".",""),10)}get formatted(){return this._formatted??=new Intl.NumberFormat(s.locale,{style:"currency",currency:this.currency}).format(parseFloat(this.amount))}toString(){return`${this.amount} ${this.currency}`}toJSON(){return{amount:this.amount,currency:this.currency}}}class C{priceLocalizationId=null;requested=c.zero("USD");localized=c.zero("USD");localizedUsd=c.zero("USD");static fromJson(e){const t=new C;return t.priceLocalizationId=e.price_localization_id||null,t.requested=c.fromJson(e.requested),t.localized=c.fromJson(e.localized),t.localizedUsd=c.fromJson(e.localized_usd),t}}let ke=class te{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/prices`}static _assertUsd(e){for(const t of e)if(t.currency!=="USD")throw new Error(`The price must be in USD. Received: ${t}`)}async localize(e){return(await this.localizeMany({prices:[e.price],expectedCountry:e.expectedCountry,expectedCurrency:e.expectedCurrency,productType:e.productType}))[0]}async localizeMany(e){te._assertUsd(e.prices);const t=await fetch(this._endpoint,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({prices:e.prices.map(r=>r.toJSON()),expected_country:e.expectedCountry,expected_currency:e.expectedCurrency,product_type:e.productType??null})});return await l.assertOk(t),(await t.json()).data.map(r=>C.fromJson(r))}};var E=(i=>(i.Pending="pending",i.Valid="valid",i.Invalid="invalid",i.Unverified="unverified",i.Canceled="canceled",i.Error="error",i))(E||{});class D{id="";validationStatus=E.Pending;validatedAt=null;platform=null;storefront=null;paymentGateway=null;transactionId="";price=c.zero("XXX");priceUsd=c.zero("USD");createdAt=new Date;static fromJson(e){const t=new D;return t.id=e.id,t.validationStatus=e.validation_status,t.validatedAt=new Date(e.validated_at),t.platform=e.platform,t.storefront=e.storefront,t.paymentGateway=e.payment_gateway,t.transactionId=e.transaction_id,t.price=c.fromJson(e.price),t.priceUsd=c.fromJson(e.price_usd),t.createdAt=new Date(e.created_at),t}get isValid(){return this.validationStatus===E.Valid||this.validationStatus===E.Unverified}}class xe{_endpoint;constructor(e){if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/purchases`}async store(e){const t=await fetch(this._endpoint,{method:"POST",headers:s.getDefaultHeaders(),body:JSON.stringify({sku:e.sku,price:e.price.toJSON(),transaction_id:e.transactionId,product_type:e.productType??null,price_localization_id:e.priceLocalizationId??null,payment_gateway:e.paymentGateway??null})});await l.assertOk(t);const n=await t.json();return D.fromJson(n.data)}async get(e){if(!e)throw new Error("The purchase ID is required");const t=await fetch(`${this._endpoint}/${e}`,{method:"GET",headers:s.getDefaultHeaders()});await l.assertOk(t);const n=await t.json();return D.fromJson(n.data)}}class Ce extends A{async initialize(){return new Promise((e,t)=>{const n=setTimeout(()=>e(),5e3);document.addEventListener("deviceready",()=>{clearTimeout(n),e()})})}getDeviceModel(){return device?device.model:null}getDeviceManufacturer(){return device?device.manufacturer:null}getOsName(){if(!device)return null;switch(device.platform?.toLowerCase()?.replace(" ","")){case"ios":return T.IOS;case"android":return T.Android;case"windows":return T.Windows;case"macos":case"macosx":return T.MacOS}return null}getOsVersion(){return device?device.version:null}}var X=(i=>(i.Male="male",i.Female="female",i.NonBinaryOther="non_binary_other",i.PreferNotToSay="prefer_not_to_say",i))(X||{}),Q=(i=>(i.PlaysaurusWeb="playsaurus_web",i.Steam="steam",i.AppStore="app_store",i.GooglePlay="google_play",i.AmazonAppstore="amazon_appstore",i.CoolMathGames="cool_math_games",i.ArmorGames="armor_games",i.CrazyGames="crazy_games",i.Microsoft="microsoft",i.MicrosoftStore="microsoft_store",i.MicrosoftStart="microsoft_start",i))(Q||{}),K=(i=>(i.General="general",i.Bundle="bundle",i))(K||{}),Y=(i=>(i.Steam="steam",i.GooglePlay="google_play",i.AppStore="app_store",i.PayPal="paypal",i.Stripe="stripe",i.ArmorGames="armor_games",i.AmazonAppstore="amazon_appstore",i))(Y||{});class Ae{static BrowserDataCollector=A;static CordovaDataCollector=Ce;static PlaysaurusNetworkError=m;static PlaysaurusValidationError=H;static PlaysaurusUnauthorizedError=J;static PlaysaurusTooManyRequestsError=G;static PlaysaurusForbiddenError=B;static PlaysaurusMaintenanceError=P;static CouponRedeemError=j;static CouponRewardDataType=_;static CloudSave=w;static AuthFrameMethod=z;static AuthFrameAction=W;static Money=c;static Purchase=D;static LocalizationResult=C;static ProductType=K;static PaymentGateway=Y;static Gender=X;static GamePlatform=L;static GameStorefront=Q;static PurchaseValidationStatus=E}class b{_atomicId=null;constructor(){}static _instance=null;static get instance(){return b._instance??=new b,b._instance}getId(){return this._atomicId?this._atomicId:(this._atomicId=localStorage.getItem("playsaurus-atomic-id"),this._atomicId?this._atomicId:(this._atomicId=me(),localStorage.setItem("playsaurus-atomic-id",this._atomicId),this._atomicId))}reset(){this._atomicId=null,localStorage.removeItem("playsaurus-atomic-id")}}class s extends Ae{static version="10.0.0";static DEFAULT_ENDPOINT="https://app.playsaurus.com/api";static _instance=null;static _analytics=null;static _announcements=null;static _coupons=null;static _auth=null;static _cloudSaves=null;static _purchases=null;static _prices=null;static _config=null;static _authToken=null;static _localeChanged=new d;static _authTokenChanged=new d;static get locale(){return s._config?.locale??"en"}static set locale(e){if(e!==s.locale){if(!s._config)throw new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.");s._config.locale=e.replace("_","-"),s._localeChanged.emit()}}static get localeChanged(){return s._localeChanged}static get authTokenChanged(){return s._authTokenChanged}static initialize(e){if(s._instance!==null)throw new Error("The Playsaurus SDK has already been initialized.");const t=e.endpoint||s.DEFAULT_ENDPOINT;e.endpoint=t?.replace(/\/$/,""),e.locale??=navigator.language||"en",e.gamePlatform??=L.Web,s._config=e,s._authToken=window.localStorage.getItem("playsaurus-auth-token"),s._authToken=s._authToken===""?null:s._authToken,(e.analytics?.enabled??!1)&&(s._analytics=new ve(e))}static get isInitialized(){return s._config!==null}static _assertInitialized(){if(!s._config)throw new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.")}static get config(){return s._assertInitialized(),s._config}static get analytics(){if(s._assertInitialized(),!s._analytics)throw new Error("The analytics service has not been enabled. Enable it in the PlaysaurusConfig.");return s._analytics}static get announcements(){return s._assertInitialized(),s._announcements??=new Se(s._config)}static get coupons(){return s._assertInitialized(),s._coupons??=new Ie(s._config)}static get auth(){return s._assertInitialized(),s._auth??=new Ee(s._config)}static get cloudSaves(){return s._assertInitialized(),s._cloudSaves??=new De(s._config)}static get purchases(){return s._assertInitialized(),s._purchases??=new xe(s._config)}static get prices(){return s._assertInitialized(),s._prices??=new ke(s._config)}static getAtomicId(){return b.instance.getId()}static resetAtomicId(){console.warn("Playsaurus SDK: Atomic ID reset. This should ONLY be used for debugging!"),b.instance.reset()}static get authToken(){return s._authToken}static set authToken(e){e!==s._authToken&&(s._authToken=e,window.localStorage.setItem("playsaurus-auth-token",e??""),s._authTokenChanged.emit())}static getDefaultHeaders(e=!0){return{...s._authToken?{Authorization:`Bearer ${s._authToken}`}:{},...e?{"Content-Type":"application/json"}:{},Accept:"application/json","Accept-Language":s.locale,"X-Requested-With":"XMLHttpRequest","X-Playsaurus-Atomic-Id":s.getAtomicId(),...s._config?.userUid?{"X-Playsaurus-User-Uid":s._config.userUid}:{},...s._config?.gamePlatform?{"X-Playsaurus-Game-Platform":s._config.gamePlatform}:{},...s._config?.gameStorefront?{"X-Playsaurus-Game-Storefront":s._config.gameStorefront}:{},...s._config?.gameVersion?{"X-Playsaurus-Game-Version":s._config.gameVersion}:{},"X-Playsaurus-Sdk-Runtime":"javascript","X-Playsaurus-Sdk-Version":s.version}}}return s});
